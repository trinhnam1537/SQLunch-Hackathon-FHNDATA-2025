<div class="admin-all-orders-container">  
  <div class="header">
    <div class="board-title">
      <p>Order: </p>
    </div>

    {{> dateFilter}}
  </div>
  
  <div class="control-bar">
    <div class="search">
      <select id="search-type" class="search-btn">
        <option value="">Search by</option>
        <option value="_id" selected>ID</option>
        <option value="customerInfo.userId">Customer Code</option>
        <option value="customerInfo.name">Customer Name</option>
      </select>
      <input type="text" id="search-input" name="name" placeholder="Search order" />
    </div>

    <div class="sort-filter">
      <div class="sort">
        <label>Sort by:</label>
        <select id="createdAt" class="filter-btn">
          <option value="">Order Date</option>
          <option value="-1">Newest Date</option>
          <option value="1">Oldest Date</option>
        </select>
        <select id="totalNewOrderPrice" class="filter-btn">
          <option value="">Order Value</option>
          <option value="-1">Value High - Low</option>
          <option value="1">Value Low - High</option>
        </select>
      </div>

      <div class="filter">
        <label>Filter:</label>
        <select id="status" class="filter-btn">
          <option value="">Order Status</option>
        </select>
        <select id="paymentMethod" class="filter-btn">
          <option value="">Payment</option>
        </select>
        <button id="clear-sort-filter" style="display: none">Clear Filter</button>
      </div>
    </div>

    <button class="create-btn" id="create-btn">
      <i class="fi fi-rr-plus"></i>
      <span>Add Order</span>
    </button>
  </div>

  {{!-- <!-- CONVERSION METRICS SECTION -->
  <div style="margin-bottom: 40px;">
    <h3 style="margin-bottom: 20px;">üîÑ Conversion Metrics</h3>

    <!-- Conversion Cards -->
    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 30px;">
      <div style="padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 4px; color: white;">
        <h6 style="color: white; margin: 0 0 10px 0; opacity: 0.9;">Payment Success Rate</h6>
        <h3 id="payment-success-rate" style="margin: 0; font-size: 36px;">-</h3>
        <small style="opacity: 0.8;">Overall payment completion</small>
      </div>

      <div style="padding: 20px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 4px; color: white;">
        <h6 style="color: white; margin: 0 0 10px 0; opacity: 0.9;">Add to Cart Rate</h6>
        <h3 id="add-to-cart-rate" style="margin: 0; font-size: 36px;">-</h3>
        <small style="opacity: 0.8;">Users adding to cart</small>
      </div>
    </div>

    <!-- Payment Success by Method -->
    <div style="padding: 20px; background: white; border-radius: 4px; border: 1px solid #ddd; margin-bottom: 20px;">
      <h5 style="color: #667eea; margin-top: 0;">üí≥ Payment Success Rate by Method</h5>
      <div id="payment-by-method" style="font-size: 13px;">
        <p style="color: #999;">Loading...</p>
      </div>
    </div>
  </div> --}}

  <div class="table">
    {{> exportFileButton}}
    <table class="all-items">
      <thead>
        <tr>
          <td style="width:  5%">No.           </td>
          <td style="width: 25%">Order Code   </td>
          <td style="width: 25%">Customer Name</td>
          <td style="width: 15%">Total Amount  </td>
          <td style="width: 20%">Order Date </td>
          <td style="width: 10%">Details      </td>
        </tr>
      </thead>

      <tbody>
        {{#each (holderData 10)}}
        <tr>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
        </tr>
        {{/each}}
      </tbody>
    </table>
  </div>

  <span class="pagination"></span>
</div>

{{!-- <style>
  .rank-badge {
    display: inline-block;
    width: 28px;
    height: 28px;
    line-height: 28px;
    text-align: center;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    font-weight: bold;
    font-size: 12px;
    margin-right: 8px;
  }

  .stat-badge {
    display: inline-block;
    padding: 3px 8px;
    border-radius: 3px;
    font-weight: 500;
    font-size: 11px;
    margin: 2px;
  }

  .stat-badge.view {
    background-color: #d1ecf1;
    color: #0c5460;
  }

  .stat-badge.purchase {
    background-color: #d4edda;
    color: #155724;
  }

  .stat-badge.interaction {
    background-color: #fff3cd;
    color: #856404;
  }

  #payment-by-method table {
    width: 100%;
    border-collapse: collapse;
  }

  #payment-by-method tr {
    border-bottom: 1px solid #f0f0f0;
  }

  #payment-by-method tr:hover {
    background-color: #f9f9f9;
  }

  #payment-by-method td {
    padding: 8px 0;
  }

  #payment-by-method thead th {
    padding: 8px 0;
    font-weight: 600;
    border-bottom: 2px solid #ddd;
    text-align: center;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', async function() {
    try {
      // Load conversion metrics
      const conversionRes = await fetch('/admin/analytics/conversion-metrics/all')
      const conversionData = await conversionRes.json()
      if (conversionData.success) {
        document.getElementById('payment-success-rate').textContent = conversionData.data.paymentSuccessRate.toFixed(2) + '%'
        document.getElementById('add-to-cart-rate').textContent = conversionData.data.addToCartRate.toFixed(2) + '%'
      }

      // Load payment success by method
      const paymentMethodRes = await fetch('/admin/analytics/payment-success-rate-by-method')
      const paymentMethodData = await paymentMethodRes.json()
      if (paymentMethodData.success) {
        renderPaymentByMethod('payment-by-method', paymentMethodData.data.rateByMethod)
      }
    } catch (error) {
      console.error('Error loading conversion metrics:', error)
    }
  })

  function renderPaymentByMethod(elementId, items) {
    const container = document.getElementById(elementId)
    if (items.length === 0) {
      container.innerHTML = '<p style="color: #999;">No data available</p>'
      return
    }

    let html = '<table><thead><tr><th>Payment Method</th><th>Total Orders</th><th>Successful</th><th>Success Rate</th></tr></thead><tbody>'
    items.forEach(item => {
      const rateColor = item.rate >= 80 ? '#1cc88a' : item.rate >= 50 ? '#f6c23e' : '#e74c3c'
      html += `
        <tr>
          <td><strong>${item.paymentMethod}</strong></td>
          <td style="text-align: center;">${item.total}</td>
          <td style="text-align: center;">${item.successful}</td>
          <td style="text-align: center;"><span style="color: ${rateColor}; font-weight: bold;">${item.rate.toFixed(2)}%</span></td>
        </tr>
      `
    })
    html += '</tbody></table>'
    container.innerHTML = html
  }
</script> --}}

<div class="admin-create-order-container" id="create-modal">
  <div id="form">
    <div class="form-title">
      <p>Add New Order</p>
    </div>
    <div class="form-group">
      <label for="orderDate">Sale Date *</label>
      <input type="date" id="orderDate" name="orderDate" required>
    </div>
    <div class="form-group">
      <label for="userId">Select Customer</label>
      <select name="userId" id="userId" required>
        <option value="" selected disabled>-- Customer --</option>
      </select>
    </div>
    <div class="form-group">
      <label for="paymentMethod">Select Payment Method</label>
      <select name="paymentMethod" id="paymentMethod" required>
        <option value="" selected disabled>-- Payment Method --</option>
      </select>
    </div>
    <div class="form-group">
      <label for="note">Notes</label>
      <input type="text" id="note" name="note">
    </div>
    <div class="form-group">
      <label>Select Product</label>
      <input type="text"  id="product-search" placeholder="Enter product name">
    </div>
    <div class="products-match"></div>

    <table>
      <thead>
        <tr>
          <td style="width:  5%;">No.</td>
          <td style="width: 40%;">Product</td>
          <td style="width: 15%; text-align:right">Unit Price</td>
          <td style="width: 10%;">Quantity</td>
          <td style="width: 15%; text-align:right">Total Amount</td>
          <td style="width: 10%;"></td>
        </tr>
      </thead>
      <tbody>
      </tbody>
      <tfoot>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td style="text-align: right">0</td>
        <td></td>
      </tfoot>
    </table>  

    <div class="submit-button">
      <button class="close-modal">Close</button>
      <button type="submit">Update</button>
    </div>
  </div>
</div>

<div class="order-details-container" id="detail-modal">
  <div id="form">
    <table id="table-1">
      <thead>
        <tr><td colspan="2">ORDER INFORMATION</td></tr>
      </thead>
      <tr>
        <td>Order Code</td>
        <td><input type="text" id="id" disabled></td>
      </tr>
      <tr>
        <td>Order Date</td>
        <td><input type="text" id="date" disabled></td>
      </tr>
      <tr>
        <td>Customer</td>
        <td style="display: flex; gap: 10px; align-items: center;">
          <input type="text" id="name" disabled>
          <a id="customer-link" href="" target="_blank">View</a>
        </td>
      </tr>
      <tr>
        <td>Phone</td>
        <td><input type="text" id="phone" disabled></td>
      </tr>
      <tr>
        <td>Address</td>
        <td><input type="text" id="address" disabled></td>
      </tr>
      <tr>
        <td>Notes</td>
        <td><input type="text" id="note" disabled></td>
      </tr>
      <tr>
        <td>Payment Method</td>
        <td><select name="paymentMethod" id="paymentMethod"></select></td>
      </tr>
      <tr>
        <td>Total Price</td>
        <td><input type="text" id="total" disabled></td>
      </tr>
      <tr>
        <td>Total After Discount</td>
        <td><input type="text" id="new-total" disabled></td>
      </tr>
      <tr>
        <td>Order Status</td>
        <td><select name="status" id="status"></select></td>
      </tr>
      <tr>
        <td>Rating Status</td>
        <td><input name="status" id="isRated" disabled></input></td>
      </tr>
      <tr>
        <td>Payment Status</td>
        <td>
          <select name="status" id="isPaid">
            <option value="false" disabled>Not Paid</option>
            <option value="true" disabled>Paid</option>
          </select>
        </td>
      </tr>
    </table>

    <table id="table-2">
      <thead>
        <tr><td colspan="5">ORDER DETAILS</td></tr>
      </thead>
      <thead>
        <tr>
          <td>STT</td>
          <td>Product Name</td>
          <td>S·ªë L∆∞·ª£ng</td>
          <td>Gi√°</td>
          <td>Details</td>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="submit-button">
      <button class="close-modal">Close</button>
      <button type="submit">Update</button>
    </div>
  </div>
</div>

<div class="product-details-container" id="detail-modal">
  <div id="form">
    <table id="table-1">
      <thead>
        <tr><td colspan="2">PRODUCT INFORMATION</td></tr>
      </thead>
      <tr>
        <td>Product ID</td>
        <td><input type="text" id="id" disabled></td>
      <tr>
      <tr>
        <td>Product Type</td>
        <td>
          <select name="categories" id="categories">
            <option value="skincare">Skincare</option>
            <option value="makeup">Makeup</option>
          </select>
          <select name="skincare" id="skincare" style="display: none">
            <option value="xit-khoang">X·ªãt Kho√°ng</option>
            <option value="mat-na">M·∫∑t N·∫°</option>
            <option value="serum">Serum</option>
            <option value="bha">BHA</option>
            <option value="tay-da-chet">T·∫©y Da Ch·∫øt</option>
            <option value="duong-da">D∆∞·ª°ng Da</option>  
            <option value="toner">Toner</option>
            <option value="nuoc-tay-trang">N∆∞·ªõc T·∫©y Trang</option>
            <option value="cham-mun">Ch·∫•m M·ª•n</option>
            <option value="kem-duong-am">Kem D∆∞·ª°ng ·∫®m</option>
            <option value="sua-rua-mat">S·ªØa R·ª≠a M·∫∑t</option>
          </select>
          <select name="makeup" id="makeup" style="display: none">
            <option value="phan-ma">Ph·∫•n M√°</option>
            <option value="mascara">Mascara</option>
            <option value="ke-mat">K·∫ª M·∫Øt</option>
            <option value="kem-chong-nang">Kem Ch·ªëng N·∫Øng</option>
            <option value="che-khuyet-diem">Che Khuy·∫øt ƒêi·ªÉm</option>
            <option value="son">Son</option>
          </select>
        </td>
      </tr>
      <tr>
        <td>Brand</td>
        <td><select name="brand" id="brand"></select></td>
      <tr>
        <td>T√™n</td>
        <td><input type="text" id="name"></td>
      </tr>
      <tr>
        <td>Purchase Price</td>
        <td><input type="text" id="purchasePrice"></td>
      </tr>
      <tr>
        <td>Old Price</td>
        <td><input type="text" id="oldPrice"></td>
      </tr>
      <tr>
        <td>New Price</td>
        <td><input type="text" id="price"></td>
      </tr>
      <tr>
        <td>Description</td>
        <td><input type="text" id="description"></td>
      </tr>
      <tr>
        <td>Details</td>
        <td><input type="text" id="details"></td>
      </tr>
      <tr>
        <td>Usage Guide</td>
        <td><input type="text" id="guide"></td>
      </tr>
      <tr>
        <td>Quantity</td>
        <td><input type="text" id="quantity"></td>
      </tr>
      <tr>
        <td>Rating</td>
        <td><input type="text" id="rate" disabled></td>
      </tr>
      <tr>
        <td>Sales Count</td>
        <td><input type="text" id="saleNumber" disabled></td>
      </tr>
      <tr>
        <td>Rating Count</td>
        <td><input type="text" id="rateNumber" disabled></td>
      </tr>
      <tr>
        <td>Product Status</td>
        <td><select name="status" id="status"></select></td>
      </tr>
      <tr>
        <td>Product Image</td>
        <td>
          <img src="" alt="loading" id="image">
          <input type="file" name="img" id="img"/>
        </td>
      </tr>
    </table>

    <div class="submit-button">
      <button class="close-modal">Close</button>
      <button type="submit">Update</button>
    </div>
  </div>
</div>

<script type="module" src="/js/admin/all/order.js"></script>